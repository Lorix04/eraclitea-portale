// Prisma schema for Portale Clienti Ente di Formazione

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  role         Role      @default(CLIENT)
  clientId     String?
  client       Client?   @relation(fields: [clientId], references: [id])
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  lastLoginAt  DateTime?
  resetToken   String?   @unique
  resetTokenExpiry DateTime?
  auditLogs    AuditLog[]
  uploadedCertificates Certificate[]
  clientTickets      Ticket[]        @relation("ClientTickets")
  assignedTickets    Ticket[]        @relation("AssignedTickets")
  ticketMessages     TicketMessage[] @relation("TicketMessages")
  notifications      Notification[]
}

enum Role {
  ADMIN
  CLIENT
}

enum VisibilityType {
  ALL
  SELECTED_CLIENTS
  BY_CATEGORY
}

model Client {
  id                String             @id @default(cuid())
  ragioneSociale    String
  piva              String             @unique
  indirizzo         String?
  referenteNome     String
  referenteEmail    String
  telefono          String?
  primaryColor      String?
  secondaryColor    String?
  sidebarBgColor    String?
  sidebarTextColor  String?
  logoPath          String?
  logoLightPath     String?
  logoFileName      String?
  logoLightFileName String?
  faviconPath       String?
  faviconFileName   String?
  isActive          Boolean            @default(true)
  createdAt         DateTime           @default(now())
  users             User[]
  employees         Employee[]
  editions          CourseEdition[]
  registrations     CourseRegistration[]
  certificates      Certificate[]
  notificationReads NotificationRead[]
  courseVisibility  CourseVisibility[]
  categories        ClientCategory[]
}

model Course {
  id               String             @id @default(cuid())
  title            String
  description      String?
  durationHours    Int?
  visibilityType   VisibilityType     @default(ALL)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  editions         CourseEdition[]
  visibility       CourseVisibility[]
  visibilityCategories CourseVisibilityCategory[]
  categories       CourseCategory[]
}

model CourseEdition {
  id               String        @id @default(cuid())
  courseId         String
  course           Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  clientId         String
  client           Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  editionNumber    Int
  startDate        DateTime?
  endDate          DateTime?
  deadlineRegistry DateTime?
  status           CourseStatus  @default(DRAFT)
  notes            String?
  registrations    CourseRegistration[]
  lessons          Lesson[]
  attendances      Attendance[]
  certificates     Certificate[]
  notifications    Notification[]
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@unique([courseId, clientId, editionNumber])
  @@index([courseId])
  @@index([clientId])
  @@index([status])
}

model Lesson {
  id            String    @id @default(cuid())
  courseEditionId String
  courseEdition  CourseEdition @relation(fields: [courseEditionId], references: [id], onDelete: Cascade)
  date          DateTime
  startTime     String?
  endTime       String?
  durationHours Float
  title         String?
  notes         String?
  attendances   Attendance[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([courseEditionId])
  @@index([date])
  @@unique([courseEditionId, date, startTime])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  courses     CourseCategory[]
  clients     ClientCategory[]
  visibleCourses CourseVisibilityCategory[]
}

model CourseCategory {
  courseId   String
  categoryId String
  assignedAt DateTime @default(now())

  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([courseId, categoryId])
}

model CourseVisibilityCategory {
  courseId   String
  categoryId String
  assignedAt DateTime @default(now())

  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([courseId, categoryId])
}

model ClientCategory {
  clientId   String
  categoryId String
  assignedAt DateTime @default(now())

  client   Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([clientId, categoryId])
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

model CourseVisibility {
  id       String @id @default(cuid())
  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([courseId, clientId])
}

model Employee {
  id            String    @id @default(cuid())
  clientId      String
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  nome          String
  cognome       String
  codiceFiscale String
  sesso         String?
  dataNascita   DateTime?
  luogoNascita  String?
  email         String?
  telefono      String?
  cellulare     String?
  indirizzo     String?
  comuneResidenza String?
  cap           String?
  mansione      String?
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  registrations CourseRegistration[]
  certificates  Certificate[]
  attendances   Attendance[]

  @@unique([clientId, codiceFiscale])
}

model EmailAccount {
  id          String   @id @default(cuid())
  name        String
  senderName  String
  senderEmail String
  smtpHost    String
  smtpPort    Int
  smtpUser    String
  smtpPass    String
  smtpSecure  Boolean  @default(true)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isDefault])
}

model EmailLog {
  id             String   @id @default(cuid())
  recipientEmail String
  recipientName  String?
  recipientId    String?
  emailType      String
  subject        String
  courseEditionId String?
  status         String   @default("SENT")
  errorMessage   String?
  sentAt         DateTime @default(now())

  @@index([recipientEmail])
  @@index([emailType])
  @@index([sentAt])
  @@index([status])
  @@index([courseEditionId])
}

model EmailPreference {
  id          String   @id @default(cuid())
  emailType   String   @unique
  label       String
  description String
  isEnabled   Boolean  @default(true)
  category    String
  updatedAt   DateTime @updatedAt
}

model CourseRegistration {
  id         String             @id @default(cuid())
  clientId   String
  client     Client             @relation(fields: [clientId], references: [id])
  courseEditionId String
  courseEdition  CourseEdition @relation(fields: [courseEditionId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee           @relation(fields: [employeeId], references: [id])
  status     RegistrationStatus @default(INSERTED)
  insertedAt DateTime           @default(now())
  updatedAt  DateTime           @updatedAt

  @@index([clientId, status])
  @@index([courseEditionId])
  @@unique([courseEditionId, employeeId])
}

enum RegistrationStatus {
  INSERTED
  CONFIRMED
  TRAINED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  ABSENT_JUSTIFIED
}

model Attendance {
  id         String           @id @default(cuid())
  lessonId   String
  lesson     Lesson           @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  courseEditionId String
  courseEdition  CourseEdition @relation(fields: [courseEditionId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  status     AttendanceStatus @default(ABSENT)
  notes      String?
  recordedBy String?
  recordedAt DateTime         @default(now())
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@unique([lessonId, employeeId])
  @@index([lessonId])
  @@index([employeeId])
  @@index([courseEditionId])
}

model Certificate {
  id         String   @id @default(cuid())
  clientId   String
  client     Client   @relation(fields: [clientId], references: [id])
  courseEditionId String?
  courseEdition  CourseEdition? @relation(fields: [courseEditionId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id])
  filePath   String
  achievedAt DateTime?
  expiresAt  DateTime?
  uploadedAt DateTime @default(now())
  uploadedBy String
  uploader   User     @relation(fields: [uploadedBy], references: [id])

  @@index([clientId])
  @@index([expiresAt])
  @@index([courseEditionId])
}

model Notification {
  id        String           @id @default(cuid())
  type      NotificationType
  title     String
  message   String?
  userId    String?
  user      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseEditionId String?
  courseEdition  CourseEdition? @relation(fields: [courseEditionId], references: [id])
  ticketId   String?
  ticket     Ticket?         @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  isGlobal  Boolean          @default(false)
  createdAt DateTime         @default(now())
  reads     NotificationRead[]

  @@index([createdAt])
  @@index([isGlobal])
  @@index([userId])
  @@index([ticketId])
}

enum NotificationType {
  NEW_EDITION
  DEADLINE_REMINDER_7D
  DEADLINE_REMINDER_2D
  CERTIFICATES_AVAILABLE
  CERTIFICATE_EXPIRING_60D
  CERTIFICATE_EXPIRING_30D
  REGISTRY_RECEIVED
  EDITION_DATES_CHANGED
  EDITION_CANCELLED
  COURSE_PUBLISHED
  CERT_UPLOADED
  REMINDER
  ATTENDANCE_RECORDED
  TICKET_OPENED
  TICKET_REPLY
  TICKET_NEW_MESSAGE
  TICKET_STATUS_CHANGED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketCategory {
  TECHNICAL
  INFO_REQUEST
  REGISTRY
  CERTIFICATES
  BILLING
  OTHER
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Ticket {
  id           String         @id @default(cuid())
  subject      String
  category     TicketCategory
  status       TicketStatus   @default(OPEN)
  priority     TicketPriority @default(MEDIUM)
  clientId     String
  client       User           @relation("ClientTickets", fields: [clientId], references: [id], onDelete: Cascade)
  assignedToId String?
  assignedTo   User?          @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)
  messages     TicketMessage[]
  notifications Notification[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  closedAt     DateTime?

  @@index([clientId])
  @@index([status])
  @@index([category])
}

model TicketMessage {
  id          String   @id @default(cuid())
  ticketId    String
  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User     @relation("TicketMessages", fields: [senderId], references: [id], onDelete: Cascade)
  message     String   @db.Text
  attachments String[] @default([])
  createdAt   DateTime @default(now())

  @@index([ticketId])
}

model NotificationRead {
  id             String       @id @default(cuid())
  notificationId String
  notification   Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)
  clientId       String
  client         Client       @relation(fields: [clientId], references: [id])
  readAt         DateTime     @default(now())

  @@unique([notificationId, clientId])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  action     String
  entityType String?
  entityId   String?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@index([action])
}
